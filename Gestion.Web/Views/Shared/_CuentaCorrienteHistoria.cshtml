@model Gestion.Web.Models.Comprobantes

@{
    var CCDetalle = (List<Gestion.Web.Models.PresupuestosDetalleDTO>)ViewData["Detalles"];
    var CCImputacion = (List<Gestion.Web.Models.Comprobantes>)ViewData["Imputaciones"];
    var CCFormaPagos = (List<Gestion.Web.Models.ComprobantesFormasPagosDTO>)ViewData["FormasPagos"];
    var Remitos = (List<Gestion.Web.Models.ComprobantesDetalleDTO>)ViewData["Remitos"];
}
<form id="CCForm">
    <div class="box-body">
        <ul class="timeline">

            <!-- timeline time label -->
            <li class="time-label">
                <span class="bg-red">
                    @(Model.FechaComprobante.ToShortDateString())
                </span>
            </li>
            <!-- /.timeline-label -->
            <!-- timeline item -->
            <li>
                <!-- timeline icon -->
                <i class="fa bg-blue"></i>
                <div class="timeline-item">
                    <span class="time"><i class="fa fa-clock-o"></i> @(Model.FechaComprobante.ToShortTimeString())</span>

                    <h3 class="timeline-header"><a asp-controller="Presupuestos" asp-action="Aprobado" asp-route-id="@Model.PresupuestoId">@Model.TipoComprobante @Model.Codigo</a> ...</h3>

                    <div class="timeline-body">
                        <b>Presupuesto: @Model.Codigo</b><br>

                        @if (@Model.TipoComprobanteFiscal != null)
                        {
                            <b>Comprobante Fiscal</b><br>
                            <b>Tipo: @Model.TipoComprobanteFiscal - Letra: @Model.LetraFiscal - Pto Venta: @Model.PtoVentaFiscal.ToString("D4") - Numero: @Model.NumeroFiscal.ToString("00000000")</b><br>
                        }


                        <br>
                        <b>Fecha:</b> @Model.FechaComprobante.ToShortDateString()<br>
                        <b>Cantidad de Productos:</b> @CCDetalle.Sum(x => x.ProductoCantidad)<br>
                        <b>SubTotal:</b> @Model.TotalSinDescuento<br>
                        <b>Descuento %:</b> @Model.DescuentoPorcentaje<br>
                        <b>Descuento $:</b> @Model.DescuentoTotal<br>
                        <b>Tipo Responsable:</b> @Model.TipoResponsable<br>
                        <b>Usuario:</b> @Model.UsuarioAlta<br>
                        <br>
                        <b>Total:</b> @Model.Total<br>
                        <b>Saldo:</b> @Model.Saldo<br>

                        <br>
                        <table class="table table-bordered">
                            <tr>
                                <th>Codigo</th>
                                <th>Producto</th>
                                <th>Precio U.</th>
                                <th>Cantidad</th>
                                <th>SubTotal</th>
                            </tr>
                            @foreach (var item in CCDetalle)
                            {
                                <tr>
                                    <td>@item.ProductoCodigo</td>
                                    <td>@item.ProductoNombre</td>
                                    <td>@item.ProductoPrecio</td>
                                    <td>@item.ProductoCantidad</td>
                                    <td>@item.SubTotal</td>
                                </tr>

                            }
                        </table>

                    </div>

                    <div class="timeline-footer">
                        <a asp-controller="Presupuestos" asp-action="PresupuestoImprimir" asp-route-id="@Model.PresupuestoId" class="btn btn-primary btn-sm" aria-hidden="true" target="_blank"><i class="fa fa-print"></i> Imprimir</a>

                        <button type="button" class="btn btn-success btn-sm" data-toggle="modal"
                                onclick="cargarDatosFiscales('@Model.Id','@Model.TipoComprobanteFiscal','@Model.LetraFiscal',@Model.PtoVentaFiscal,@Model.NumeroFiscal);"
                                data-target="#modal-fiscales">
                            Cargar Datos Fiscales
                        </button>
                    </div>
                </div>
            </li>
            <!-- END timeline item -->
            <!-- timeline time label -->
            @foreach (var item in CCImputacion)
            {
                <li class="time-label">
                    <span class="bg-red">
                        @(item.FechaComprobante.ToShortDateString())
                    </span>
                </li>
                <!-- /.timeline-label -->
                <!-- timeline item -->
                <li>
                    <!-- timeline icon -->
                    <i class="fa bg-blue"></i>
                    <div class="timeline-item">
                        <span class="time"><i class="fa fa-clock-o"></i> @(item.FechaComprobante.ToShortTimeString())</span>

                        <h3 class="timeline-header"><a>@item.TipoComprobante @item.Codigo</a> ...</h3>

                        <div class="timeline-body">
                            <b>@item.TipoComprobante: @item.Codigo</b><br>

                            @if (item.TipoComprobanteFiscal != null)
                            {
                                <b>Comprobante Fiscal</b><br>
                                <b>Tipo: @item.TipoComprobanteFiscal - Letra: @item.LetraFiscal - Pto Venta: @item.PtoVentaFiscal.ToString("D4") - Numero: @item.NumeroFiscal.ToString("00000000")</b><br>
                            }
                            <br>
                            <b>Fecha:</b> @item.FechaComprobante.ToShortDateString()<br>
                            <b>Total sin Descuento:</b> @item.Total<br>
                            <b>Total sin Impuesto:</b> @item.TotalSinImpuesto<br>
                            <b>Descuento:</b> @item.DescuentoTotal<br>
                            <b>Usuario:</b> @item.UsuarioAlta<br>
                            <br>
                            @if (item.Anulado == true)
                            {
                                <div class="callout callout-danger">
                                    <h4>ANULADO</h4>

                                    <b>Fecha Anulacion:</b> @item.FechaAnulacion.ToShortDateString()<br>
                                    <b>Tipo Comprobante Anula:</b> @item.TipoComprobanteAnula<br>
                                    <b>Comprobante Anula:</b> @item.CodigoAnula<br>
                                    <b>Usuario Anulacion:</b> @item.UsuarioAnula<br>
                                </div>
                                <br>

                            }

                            <h4>Detalle</h4>
                            @foreach (var formas in CCFormaPagos.Where(x => x.ComprobanteId == item.Id))
                            {
                                switch (formas.FormaPagoTipo)
                                {
                                    case "E":
                                        <div class="alert alert-danger alert-dismissible">
                                            <h4>
                                                <i class="icon fa fa-bitbucket"></i> @formas.FormaPago
                                            </h4>
                                            <p>Total: @formas.Total </p>
                                            <p>Observaciones: @formas.Observaciones</p>
                                            <p>Usuario: @formas.UsuarioAlta - Fecha: @formas.FechaAlta</p>

                                        </div>
                                        break;
                                    case "C":
                                        <div class="alert alert-info alert-dismissible">
                                            <h4>
                                                <i class="icon fa fa-bitbucket"></i> @formas.FormaPago
                                            </h4>
                                            <p>Nombre: @formas.TarjetaCliente </p>
                                            <p>Numero: @formas.TarjetaNumero - Vence: @formas.TarjetaVenceAño / @formas.TarjetaVenceMes </p>
                                            <p>Total: @formas.Total </p>
                                            <p>Importe: @formas.Importe - Cuota: @formas.Cuota - Interes: @formas.Interes</p>
                                            <p>Observaciones: @formas.Observaciones</p>
                                            <p>Usuario: @formas.UsuarioAlta - Fecha: @formas.FechaAlta</p>

                                        </div>
                                        break;
                                    case "D":
                                        <div class="alert alert-success alert-dismissible">
                                            <h4>
                                                <i class="icon fa fa-bitbucket"></i> @formas.FormaPago
                                            </h4>
                                            <p>Nombre: @formas.TarjetaCliente </p>
                                            <p>Numero: @formas.TarjetaNumero - Vence: @formas.TarjetaVenceAño / @formas.TarjetaVenceMes </p>
                                            <p>Total: @formas.Total </p>
                                            <p>Observaciones: @formas.Observaciones</p>
                                            <p>Usuario: @formas.UsuarioAlta - Fecha: @formas.FechaAlta</p>
                                        </div>
                                        break;
                                    case "X":
                                        <div class="alert alert-warning alert-dismissible">
                                            <h4>
                                                <i class="icon fa fa-bitbucket"></i> @formas.FormaPago
                                            </h4>
                                            <p>Numero: @formas.ChequeNumero </p>
                                            <p>Nombre: @formas.ChequeNombre </p>
                                            <p>Cuit: @formas.ChequeCuit </p>
                                            <p>Fecha: @formas.ChequeFechaEmision </p>
                                            <p>Vence: @formas.ChequeFechaVencimiento </p>
                                            <p>Cuit: @formas.ChequeCuenta</p>
                                            <p>Total: @formas.Total </p>
                                            <p>Observaciones: @formas.Observaciones</p>
                                            <p>Usuario: @formas.UsuarioAlta - Fecha: @formas.FechaAlta</p>

                                        </div>
                                        break;
                                    case "O":
                                        <div class="alert alert-bitbucket alert-dismissible">
                                            <h4>
                                                <i class="icon fa fa-bitbucket"></i> @formas.FormaPago
                                            </h4>
                                            <p>Total: @formas.Total </p>
                                            <p>Forma Pago: @formas.Otros</p>
                                            <p>Observaciones: @formas.Observaciones</p>
                                            <p>Usuario: @formas.UsuarioAlta - Fecha: @formas.FechaAlta</p>

                                        </div>
                                        break;
                                    default:
                                        break;
                                }

                            }
                            
                            @if (item.Total == 0)
                            {
                                <table class="table table-bordered">
                                    <tr>
                                        <th>Codigo</th>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                    </tr>
                                    @foreach (var remitos in Remitos.Where(x => x.ComprobanteId == item.Id))
                                    {

                                        <tr>
                                            <td>@remitos.ProductoCodigo</td>
                                            <td>@remitos.ProductoNombre</td>
                                            <td>@remitos.Cantidad</td>
                                        </tr>

                                    }
                                </table>

                            }


                        </div>
                        @if (item.Anulado != true)
                        {
                            @if (item.Total > 0)
                            {

                                <div class="timeline-footer">
                                    <a asp-controller="Clientes" asp-action="ReciboImprimir" asp-route-id="@item.Id" class="btn btn-primary btn-sm" aria-hidden="true" target="_blank"><i class="fa fa-print"></i> Imprimir</a>
                                    <button type="button" class="btn btn-success btn-sm" data-toggle="modal"
                                            onclick="cargarDatosFiscales('@item.Id','@item.TipoComprobanteFiscal','@item.LetraFiscal',@item.PtoVentaFiscal,@item.NumeroFiscal);"
                                            data-target="#modal-fiscales">
                                        Cargar Datos Fiscales
                                    </button>

                                    <a asp-controller="Clientes" asp-action="ReciboAnular" asp-route-id="@item.Id" asp-route-comp="@Model.Id" class="btn btn-warning btn-sm pull-right" aria-hidden="true"><i class="glyphicon glyphicon-remove"></i> Anular</a>
                                </div>
                            }
                            @if (item.Total == 0)
                            {

                    <div class="timeline-footer">
                        <a asp-controller="Comprobantes" asp-action="RemitoImprimir" asp-route-id="@item.Id" class="btn btn-primary btn-sm" aria-hidden="true" target="_blank"><i class="fa fa-print"></i> Imprimir</a>
                        

                    </div>
                            }
                        }

                    </div>
                </li>
            }
            <!-- END timeline item -->
            ...
        </ul>
    </div>
</form>

<div class="modal fade" id="modal-fiscales">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Ingresar Datos Fiscales</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mdlId" />

                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="form-group">
                    <label class="control-label">Tipo Comprobante (FA,NC,ND,RE)</label>
                    <input id="mdlTipoComprobanteFiscal"  class="form-control input-sm" maxlength="2" />
                    <span id="mTipoComprobanteFiscal" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label class="control-label">Letra</label>
                    <input id="mdlLetraFiscal"  class="form-control input-sm" maxlength="1"/>
                    <span id="mLetraFiscal" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label class="control-label">Pto Venta</label>
                    <input id="mdlPtoVentaFiscal"  class="form-control input-sm" maxlength="4" onkeypress="return FiltrarEnteros(event,this);" />
                    <span id="mPtoVentaFiscal" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label class="control-label">Numero</label>
                    <input id="mdlNumeroFiscal"  class="form-control input-sm" maxlength="8" onkeypress="return FiltrarEnteros(event,this);"/>
                    <span id="mNumeroFiscal" class="text-danger"></span>
                </div>

                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cerrar</button>
                <button type="button" id="btnGuardar" class="btn btn-primary" onclick="validarFiscalModal()">Guardar Datos Fiscales</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->